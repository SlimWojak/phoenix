# Execution Surface Contract — S28.C
# VERSION: 0.2
# STATUS: MOCK_SIGNALS (PAPER_ONLY)

contract_id: EXEC-SURFACE-001
version: "0.2.0"
sprint: "S28.C"
status: ACTIVE

# =============================================================================
# MODULE IDENTITY
# =============================================================================

module:
  id: phoenix.execution
  name: Execution Path (Mock Signals)
  tier: T0/T1/T2_MOCKED  # T2 with paper broker only
  mode: MOCK_SIGNALS
  capital: PAPER_ONLY

# =============================================================================
# S28.C CAPABILITIES
# =============================================================================

capabilities:
  intent_validation:
    schema_enforcement: true
    deterministic_hash: true
    halt_gate_integration: true
  
  position_lifecycle:
    states: [PENDING, OPEN, PARTIAL, CLOSED, HALTED]
    valid_transitions: enforced
    state_machine: deterministic
  
  paper_broker:
    fill_mode: IMMEDIATE
    slippage: NONE  # v0 simplified
    fees: NONE      # v0 simplified
    pnl_calculation: SIMPLIFIED_V0
  
  replay_harness:
    deterministic: PROVEN
    halt_integration: true
    mock_signals: SYNTHETIC_ONLY

# =============================================================================
# PERMISSIONS
# =============================================================================

permissions:
  reads:
    - cso.beads.approved
    - governance.halt_signal
    - market_data.prices
  
  writes:
    - execution.intents
    - execution.positions
    - execution.orders_paper
    - execution.blocked_log
  
  forbidden:
    - broker.live
    - orders.live
    - capital.real
    - submit_order_live
    - execute_order_live

# =============================================================================
# INVARIANTS
# =============================================================================

invariants:
  - id: INV-GOV-HALT-BEFORE-ACTION
    description: "Halt check precedes any capital-affecting action"
    enforcement: HaltGateViolation exception
    test: test_halt_before_exec.py
    status: PROVEN
  
  - id: INV-CONTRACT-1
    description: "State machine is deterministic"
    enforcement: hash comparison
    test: test_execution_path.py::TestGateC2Deterministic
    status: PROVEN
  
  - id: INV-EXEC-LIFECYCLE-1
    description: "Only valid state transitions allowed"
    enforcement: InvalidTransitionError exception
    test: test_execution_path.py::TestGateC4LifecycleValid
    status: PROVEN

# =============================================================================
# POSITION STATE MACHINE
# =============================================================================

position_lifecycle:
  states:
    PENDING:
      description: "Intent received, order not yet filled"
      transitions_to: [OPEN, PARTIAL, CLOSED, HALTED]
    
    OPEN:
      description: "Order filled, position active"
      transitions_to: [PARTIAL, CLOSED, HALTED]
    
    PARTIAL:
      description: "Partial fill received"
      transitions_to: [OPEN, CLOSED, HALTED]
    
    CLOSED:
      description: "Exit complete, position closed"
      transitions_to: []  # Terminal
    
    HALTED:
      description: "System halt killed position"
      transitions_to: []  # Terminal

# =============================================================================
# P&L SEMANTICS (v0 SIMPLIFIED)
# =============================================================================

pnl_v0:
  formula: "(exit_price - entry_price) * size * direction_mult"
  direction_multiplier:
    LONG: +1
    SHORT: -1
  exclusions:
    - fees: "NOT INCLUDED (v0)"
    - slippage: "NOT INCLUDED (v0)"
    - commission: "NOT INCLUDED (v0)"
    - swap: "NOT INCLUDED (v0)"
  note: "GPT_LINT L28-C1: documented as simplified P&L v0"

# =============================================================================
# INTENT SCHEMA
# =============================================================================

intent_schema:
  required_fields:
    - intent_id: string
    - intent_type: enum[ENTRY, EXIT, SCALE, HEDGE, CANCEL]
    - status: enum[PENDING, BLOCKED, APPROVED, REJECTED, EXPIRED]
    - created_at: datetime
    - symbol: string
    - direction: enum[LONG, SHORT]
    - size: float
    - source_state_hash: string
    - intent_hash: string
  
  optional_fields:
    - expires_at: datetime
    - entry_price: float
    - stop_loss: float
    - take_profit: float
    - source_bead_id: string

# =============================================================================
# HALT GATE
# =============================================================================

halt_gate:
  pattern: "halt-first"
  enforcement: "HaltGate.check_before(action)"
  latency: "<50ms (INV-HALT-1)"
  
  flow:
    1_receive_intent: "Intent arrives"
    2_check_halt: "MUST check halt_signal"
    3_if_halted: "Block intent, raise BrokerHaltedError"
    4_if_clear: "Process order via paper broker"
  
  violations:
    - skip_check: "HaltGateViolation raised"
    - execute_while_halted: "BrokerHaltedError raised"
    - invalid_transition: "InvalidTransitionError raised"

# =============================================================================
# EXIT GATES (S28.C)
# =============================================================================

exit_gates:
  GATE_C1_PAPER_TRADES:
    test: test_execution_path.py::TestGateC1PaperTrades
    criterion: "signal → order → position → P&L cycle complete"
    status: PASS
  
  GATE_C2_DETERMINISTIC:
    test: test_execution_path.py::TestGateC2Deterministic
    criterion: "same replay = same result (hash match)"
    status: PASS
  
  GATE_C3_HALT_RESPECTED:
    test: test_execution_path.py::TestGateC3HaltRespected
    criterion: "halt stops all execution"
    status: PASS
  
  GATE_C4_LIFECYCLE_VALID:
    test: test_execution_path.py::TestGateC4LifecycleValid
    criterion: "only valid state transitions"
    status: PASS

# =============================================================================
# MOCK SIGNALS
# =============================================================================

mock_signals:
  mode: SYNTHETIC_ONLY
  source: MockSignalGenerator
  patterns:
    - FIXED: "signals at fixed intervals"
    - ALTERNATING: "alternate long/short"
    - FROM_PRICES: "momentum from price data"
  note: "NOT Olya methodology — testing only"

# =============================================================================
# CONSTRAINTS
# =============================================================================

constraints:
  capital: "PAPER_ONLY — no real money"
  signals: "MOCK — synthetic patterns only"
  broker: "STUB — immediate fills, no market simulation"
  pnl: "SIMPLIFIED_V0 — no fees/slippage"

# =============================================================================
# CHANGELOG
# =============================================================================

changelog:
  - version: "0.2.0"
    date: "2026-01-23"
    sprint: "S28.C"
    changes:
      - Added position lifecycle state machine
      - Added paper broker stub
      - Added replay harness
      - Implemented P&L v0 (simplified)
      - 23/23 tests passing
      - All exit gates PASS
  
  - version: "0.1.0"
    date: "2026-01-22"
    sprint: "S27.0"
    changes:
      - Initial skeleton
      - Halt-first wiring
      - Intent objects only
      - No capital actions
