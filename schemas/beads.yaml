# =============================================================================
# BEADS SCHEMA v1.0
# =============================================================================
# CANONICAL SOURCE OF TRUTH
# Location: phoenix/schemas/beads.yaml
# Created: 2026-01-27 (PRE-S30)
#
# This file IS the law. ROADMAP lines 242-340 are now HISTORICAL REFERENCE.
# All bead changes go through this file directly.
# =============================================================================

schema_version: "1.0"
schema_type: beads
last_updated: "2026-01-27"

# =============================================================================
# BASE BEAD FIELDS (Required on ALL bead types)
# =============================================================================
# These fields implement:
# - GROK hash chain (merkle-lite lineage)
# - GPT append-only audit trail
# - Immutability enforcement

base_bead_fields:
  bead_id:
    type: uuid
    description: Unique identifier for this bead
    required: true

  bead_type:
    type: enum
    values: [HUNT, CONTEXT_SNAPSHOT, PERFORMANCE, AUTOPSY, POSITION, PROMOTION, CONFIG_CHANGE, KILL_FLAG, T2_TOKEN, RECONCILIATION_DRIFT, RECONCILIATION_RESOLUTION, IBKR_SESSION, HEARTBEAT]
    description: Type discriminator
    required: true

  prev_bead_id:
    type: uuid|null
    description: Previous bead in chain (null for genesis beads)
    required: true
    note: Creates merkle-lite lineage for audit

  bead_hash:
    type: string
    description: SHA256(content + prev_hash + timestamp + signer)
    required: true
    format: hex64

  timestamp_utc:
    type: datetime
    format: ISO8601
    description: Creation timestamp (UTC)
    required: true

  signer:
    type: enum
    values: [system, human, claude]
    description: Entity that created/signed this bead
    required: true

  version:
    type: string
    default: "1.0"
    description: Bead schema version
    required: true

# =============================================================================
# CONSTRAINTS (Enforced by runtime)
# =============================================================================

constraints:
  append_only: true
  description: Beads are immutable once written

  hash_chain: true
  description: prev_bead_id creates merkle-lite lineage

  no_raw_claude: true
  description: Never store raw LLM outputs directly in beads

invariants:
  - INV-BEAD-IMMUTABLE-1: "Beads cannot be modified after creation"
  - INV-BEAD-HASH-1: "bead_hash must match computed hash of content"
  - INV-BEAD-CHAIN-1: "prev_bead_id must reference existing bead or be null"

# =============================================================================
# BEAD TYPE: HUNT
# =============================================================================
# Captures hypothesis testing cycle
# Created by: Hunt surface
# Consumers: Athena, Shadow, Promotion decisions

HUNT_BEAD:
  extends: base_bead_fields
  bead_type_value: "HUNT"

  fields:
    hpg_version:
      type: string
      description: HPG schema version used
      required: true

    hypothesis_text:
      type: string
      description: Original natural language hypothesis
      required: true
      max_length: 1000

    hpg_json:
      type: object
      description: Frozen HPG parameters (validated against hpg_schema)
      required: true

    data_window:
      type: object
      required: true
      fields:
        start:
          type: datetime
          format: ISO8601
        end:
          type: datetime
          format: ISO8601

    variants_tested:
      type: int
      description: Number of parameter variations tested
      required: true
      min: 1
      max: 50

    survivors:
      type: list
      description: Strategies that passed survival criteria
      required: true
      item_schema:
        variant_id:
          type: string
        params:
          type: object
        sharpe:
          type: float
        win_rate:
          type: float
          min: 0.0
          max: 1.0
        max_drawdown:
          type: float
          max: 0.0  # Negative value

    random_seed:
      type: int
      description: Seed for reproducibility (INV-HUNT-DET-1)
      required: true

# =============================================================================
# BEAD TYPE: CONTEXT_SNAPSHOT
# =============================================================================
# Captures session cognitive state
# Created by: Checkpoint surface
# Consumers: Session resume, Athena

CONTEXT_SNAPSHOT_BEAD:
  extends: base_bead_fields
  bead_type_value: "CONTEXT_SNAPSHOT"

  fields:
    session_id:
      type: uuid
      description: Session this snapshot belongs to
      required: true

    intuitions:
      type: list
      item_type: string
      description: Current working intuitions
      required: true
      max_items: 20

    open_questions:
      type: list
      item_type: string
      description: Unresolved questions
      required: true
      max_items: 10

    current_hypothesis:
      type: string
      description: Active hypothesis being explored
      required: false
      max_length: 500

    cognitive_momentum:
      type: object
      required: true
      fields:
        operator_stance:
          type: enum
          values: [skeptical, neutral, confident, frustrated, exploratory]
        momentum_direction:
          type: string
          max_length: 200
        discarded_paths:
          type: list
          item_type: string
          max_items: 10
        emotional_context:
          type: string
          max_length: 200

# =============================================================================
# BEAD TYPE: PERFORMANCE
# =============================================================================
# Captures strategy performance metrics
# Created by: Shadow boxer, Live execution
# Consumers: Promotion decisions, Athena

PERFORMANCE_BEAD:
  extends: base_bead_fields
  bead_type_value: "PERFORMANCE"

  fields:
    source:
      type: enum
      values: [SHADOW, LIVE]
      description: Paper or live tracking
      required: true

    period:
      type: object
      required: true
      fields:
        start:
          type: datetime
          format: ISO8601
        end:
          type: datetime
          format: ISO8601

    pair:
      type: string
      description: Trading pair (validated against pairs.yaml)
      required: true

    strategy_id:
      type: string
      description: Reference to Hunt survivor
      required: true

    metrics:
      type: object
      required: true
      fields:
        sharpe:
          type: float
        win_rate:
          type: float
          min: 0.0
          max: 1.0
        profit_factor:
          type: float
          min: 0.0
        max_drawdown:
          type: float
          max: 0.0
        trades:
          type: int
          min: 0

    signals_seen:
      type: int
      description: Total signals observed
      required: true

    signals_taken:
      type: int
      description: Signals acted upon
      required: true

# =============================================================================
# BEAD TYPE: AUTOPSY
# =============================================================================
# Post-trade analysis
# Created by: Autopsy surface
# Consumers: Learning loop, Athena

AUTOPSY_BEAD:
  extends: base_bead_fields
  bead_type_value: "AUTOPSY"

  fields:
    position_id:
      type: uuid
      description: Reference to POSITION bead
      required: true

    entry_thesis:
      type: object
      required: true
      fields:
        confidence:
          type: float
          min: 0.0
          max: 1.0
        reasoning_hash:
          type: string
          description: Hash of reasoning at entry time
        setup_type:
          type: string

    outcome:
      type: object
      required: true
      fields:
        result:
          type: enum
          values: [WIN, LOSS, BREAKEVEN]
        pnl_percent:
          type: float
        duration:
          type: string
          description: ISO8601 duration

    comparison:
      type: object
      required: true
      fields:
        thesis_valid:
          type: bool
          description: Did the entry thesis hold?
        unknown_factors:
          type: list
          item_type: string
          max_items: 10
        learnings:
          type: list
          item_type: string
          max_items: 10

# =============================================================================
# BEAD TYPE: POSITION
# =============================================================================
# Position lifecycle tracking
# Created by: Execution path
# Consumers: Shadow, Live execution, Autopsy

POSITION_BEAD:
  extends: base_bead_fields
  bead_type_value: "POSITION"

  fields:
    position_id:
      type: uuid
      description: Unique position identifier
      required: true

    state:
      type: enum
      values: [PROPOSED, APPROVED, SUBMITTED, FILLED, MANAGED, CLOSED]
      description: Position lifecycle state
      required: true

    pair:
      type: string
      description: Trading pair
      required: true

    direction:
      type: enum
      values: [LONG, SHORT]
      required: true

    entry_price:
      type: float
      description: Filled entry price
      required: false  # Set when FILLED

    exit_price:
      type: float
      description: Exit price
      required: false  # Set when CLOSED

    size:
      type: float
      description: Position size
      required: true
      min: 0.0

    pnl:
      type: float
      description: Realized P&L
      required: false  # Set when CLOSED

    approval_token:
      type: string
      description: Human approval token for T2 audit
      required: false  # Required for APPROVED state

# =============================================================================
# BEAD TYPE: PROMOTION
# =============================================================================
# Strategy promotion decisions
# Created by: Olya (human) via Promotion surface
# Consumers: Shadow â†’ Live transition

PROMOTION_BEAD:
  extends: base_bead_fields
  bead_type_value: "PROMOTION"

  fields:
    strategy_id:
      type: string
      description: Strategy being promoted
      required: true

    evidence_bundle_bead:
      type: uuid
      description: Reference to PERFORMANCE bead(s) supporting promotion
      required: true

    olya_reasoning:
      type: string
      description: Human reasoning for promotion decision
      required: true
      max_length: 2000

    approved_by:
      type: string
      description: Approver identifier
      required: true

# =============================================================================
# BEAD TYPE: CONFIG_CHANGE (S31)
# =============================================================================
# Parameter change tracking
# Created by: ParamsLoader on config change
# Consumers: Signalman (decay correlation), Autopsy (param impact)

CONFIG_CHANGE_BEAD:
  extends: base_bead_fields
  bead_type_value: "CONFIG_CHANGE"

  fields:
    config_file:
      type: string
      description: Config file that changed (e.g., "cso_params.yaml")
      required: true

    param_diff:
      type: object
      required: true
      fields:
        changed_keys:
          type: list
          item_type: string
          description: Keys that changed
        old_values:
          type: object
          description: Previous values for changed keys
        new_values:
          type: object
          description: New values for changed keys

    old_hash:
      type: string
      description: Hash of config before change
      required: true
      format: hex64

    new_hash:
      type: string
      description: Hash of config after change
      required: true
      format: hex64

    operator:
      type: string
      description: Who made the change
      required: true

    trigger:
      type: enum
      values: [MANUAL, SCHEDULED, AUTOPSY_LEARNING, SYSTEM]
      description: What triggered the change
      required: true

# =============================================================================
# BEAD TYPE: KILL_FLAG (S31)
# =============================================================================
# ONE-WAY-KILL status tracking
# Created by: Signalman on decay detection, or manual
# Consumers: Dispatcher (blocks new entries), Execution gate

KILL_FLAG_BEAD:
  extends: base_bead_fields
  bead_type_value: "KILL_FLAG"

  fields:
    strategy_id:
      type: string
      description: Strategy affected by kill flag
      required: true

    active:
      type: bool
      description: TRUE = kill active (no new entries), FALSE = lifted
      required: true

    reason:
      type: string
      description: Reason for kill flag
      required: true
      max_length: 500

    triggered_by:
      type: enum
      values: [SIGNALMAN, MANUAL, SYSTEM]
      description: Source of kill flag
      required: true

    decay_metrics:
      type: object
      required: false
      description: Decay metrics that triggered kill (if from Signalman)
      fields:
        sharpe_drift:
          type: float
        win_rate_drift:
          type: float
        ks_p_value:
          type: float

    lifted_by:
      type: string
      description: Who lifted the kill (if active=false)
      required: false

    lifted_reason:
      type: string
      description: Reason for lifting (if active=false)
      required: false

# =============================================================================
# BEAD TYPE: T2_TOKEN (S32)
# =============================================================================
# T2 approval token lifecycle tracking
# Created by: T2 approval system
# Consumers: IBKR connector, audit

T2_TOKEN_BEAD:
  extends: base_bead_fields
  bead_type_value: "T2_TOKEN"

  fields:
    token_id:
      type: uuid
      description: Unique identifier for the approval token
      required: true

    intent_id:
      type: uuid
      description: The intent this token authorizes
      required: true

    event:
      type: enum
      values: [ISSUED, USED, EXPIRED, REJECTED]
      description: Token lifecycle event
      required: true

    reason:
      type: string
      description: Reason for REJECTED or EXPIRED (null for ISSUED/USED)
      required: false
      max_length: 500

    evidence_hash:
      type: string
      description: Hash of evidence bundle that was approved
      required: true
      format: hex64

    expires_at:
      type: datetime
      format: ISO8601
      description: When this token expires (5 min from issue)
      required: true

# =============================================================================
# BEAD TYPE: RECONCILIATION_DRIFT (S32)
# =============================================================================
# Records detected drift between Phoenix state and broker state
# Created by: Reconciliation worker
# Consumers: Alert pipeline, resolution workflow

RECONCILIATION_DRIFT_BEAD:
  extends: base_bead_fields
  bead_type_value: "RECONCILIATION_DRIFT"

  fields:
    drift_type:
      type: enum
      values: [POSITION_COUNT, POSITION_SIZE, PNL, ORDER_STATUS, PARTIAL_FILL]
      description: Type of drift detected
      required: true

    phoenix_state:
      type: object
      description: Phoenix's view of the state
      required: true

    broker_state:
      type: object
      description: Broker's reported state
      required: true

    severity:
      type: enum
      values: [WARNING, CRITICAL]
      description: Severity of the drift
      required: true

    position_id:
      type: string
      description: Affected position ID (if applicable)
      required: false

    alert_sent:
      type: bool
      description: Whether alert was dispatched
      required: true
      default: true

# =============================================================================
# BEAD TYPE: RECONCILIATION_RESOLUTION (S32)
# =============================================================================
# Records how a drift was resolved
# Created by: Human via resolution interface
# Consumers: Audit, promotion checklist

RECONCILIATION_RESOLUTION_BEAD:
  extends: base_bead_fields
  bead_type_value: "RECONCILIATION_RESOLUTION"

  fields:
    drift_bead_id:
      type: uuid
      description: Reference to the RECONCILIATION_DRIFT bead being resolved
      required: true

    resolution:
      type: enum
      values: [PHOENIX_CORRECTED, BROKER_CORRECTED, ACKNOWLEDGED, STALE_IGNORED]
      description: How the drift was resolved
      required: true

    resolved_by:
      type: string
      description: Human identifier who resolved
      required: true

    notes:
      type: string
      description: Resolution notes
      required: false
      max_length: 1000

    time_to_resolve_sec:
      type: int
      description: Seconds from drift detection to resolution
      required: true

# =============================================================================
# BEAD TYPE: IBKR_SESSION (S33)
# =============================================================================
# IBKR connection lifecycle tracking
# Created by: IBKR connector on connect/disconnect/reconnect
# Consumers: Athena (connection gap queries), ops monitoring

IBKR_SESSION_BEAD:
  extends: base_bead_fields
  bead_type_value: "IBKR_SESSION"

  fields:
    event:
      type: enum
      values: [CONNECT, DISCONNECT, RECONNECT]
      description: Session event type
      required: true

    mode:
      type: enum
      values: [MOCK, PAPER, LIVE]
      description: Connection mode
      required: true

    account:
      type: string
      description: Account ID (DU* for paper, U* for live)
      required: true

    port:
      type: int
      description: Gateway port (4002 paper, 4001 live)
      required: true

    gateway_version:
      type: string
      description: IB Gateway version (if available)
      required: false

    reconnect_attempt:
      type: int
      description: Attempt number (if RECONNECT event)
      required: false
      default: 0

# =============================================================================
# BEAD TYPE: HEARTBEAT (S33)
# =============================================================================
# System health monitoring
# Created by: Heartbeat daemon every 30s
# Consumers: Athena (health gap queries), ops alerting

HEARTBEAT_BEAD:
  extends: base_bead_fields
  bead_type_value: "HEARTBEAT"

  fields:
    status:
      type: enum
      values: [HEALTHY, DEGRADED, MISSED]
      description: Health status
      required: true

    checks:
      type: object
      required: true
      description: Individual health check results
      fields:
        process_alive:
          type: bool
          description: Daemon processes running
        ibkr_connected:
          type: bool
          description: IBKR connection alive
        semantic_healthy:
          type: bool
          description: Semantic health checks pass

    details:
      type: object
      description: Details if DEGRADED or MISSED
      required: false

    miss_count:
      type: int
      description: Consecutive miss count
      required: false
      default: 0
